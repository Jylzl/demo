tinymce.PluginManager.add('bdmap', function(editor, url) {
    var pluginName='插入百度地图';
    var baseURL=tinymce.baseURL;
    var iframe1 = baseURL+'/plugins/bdmap/map.html';
    var bdmap_width = function (editor) {
        return editor.getParam('bdmap_width', 560);
    };
    var bdmap_height = function (editor) {
        return editor.getParam('bdmap_height', 362);
    };
    window.tinymceLng='';
    window.tinymceLat='';
    var openDialog = function() {
        return editor.windowManager.openUrl({
            title: pluginName,
            size: 'large',
            //width: 800,
            //height: 500,
            url:iframe1,
            buttons: [
                {
                    type: 'cancel',
                    text: 'Close'
                },
                {
                    type: 'custom',
                    text: 'Save',
                    name: 'save',
                    primary: true
                },
            ],
            onAction: function (api, details) {
                switch (details.name) {
                    case 'save':
                        html='<iframe src="'+baseURL+'/plugins/bdmap/bd.html?center='+tinymceLng+'%2C'+tinymceLat+'&zoom=14&width='+(bdmap_width(editor)-2)+'&height='+(bdmap_height(editor)-2)+'" frameborder="0" style="width:'+bdmap_width(editor)+'px;height:'+bdmap_height(editor)+'px;">';
                        editor.insertContent(html);
                        api.close();
                        break;
                    default:
                        break;
                }
                
            }
        });
    };
    
    editor.ui.registry.addButton('bdmap', {
        //icon: 'preferences',
        text: '<svg viewBox="0 0 1024 1024" xmlns="http://www.w3.org/2000/svg" width="24" height="24"><path d="M670.773 733.012c21.138-46.061 45.56-73.673 64.495-90.503 10.336-9.183 21.137-16.799 32.524-21.678-5.968-8.126-10.592-15.332-15.18-22.225-8.418-12.636-17.344-27.09-21.679-34.136-28.718 15.71-55.9 48.16-77.502 76.953-12.543 16.743-23.84 34.684-34.685 53.659l52.027 37.93zM450.2 803.474c5.963 14.608 9.213 29.292 13.549 40.623 1.632 7.057 3.246 13.531 5.42 19.54 19.506-6.009 38.965-12.021 57.996-20.116 32.466-13.645 70.991-33.01 95.373-58.482l-44.976-48.234c-8.123 8.13-17.85 14.695-30.35 22.769-21.098 13.606-51.481 30.35-97.012 43.9zM373.785 204.07c0-52.027 43.356-95.385 95.385-95.385 53.66 0 94.843 43.359 94.843 95.385 0 53.648-41.181 95.385-94.843 95.385-52.029 0-95.385-41.738-95.385-95.385zm-105.67 0c0 20.053 2.704 39.558 8.67 58.526h-2.173c16.794 39.02 35.78 79.918 52.028 111.103l27.096 52.028c47.472 91.163 105.678 191.312 114.348 204.32.543.542.543.542.543 1.085 0 .547 0 1.078.542 1.078 32.512-54.732 60.576-104.127 81.836-143.609l34.144-63.422 26.556-52.028c15.762-30.858 34.685-70.984 51.486-110.556h-1.633c5.967-18.968 8.671-38.473 8.671-58.526 0-110.565-90.507-200.524-201.062-200.524-111.095 0-201.055 89.96-201.055 200.525zm-38.492 596.14c15.182 11.392 31.3 21.346 48.234 30.36 30.227 15.962 68.83 34.112 112.728 40.7 1.633-13.064 2.473-29.944 4.336-42.319l3.251-21.683c-11.925-2.174-25.602-5.613-40.1-10.847-24.523-8.847-55.821-23.84-90.507-48.229-9.213 13.545-18.634 25.705-26.014 35.765l-11.929 16.252zM17.185 949.775c0 41.16 33.596 74.226 74.248 74.226h841.112a74.01 74.01 0 0 0 74.239-74.226V336.85a74.012 74.012 0 0 0-74.239-74.255h-204.32l-35.774 100.27h202.152c9.213 0 15.723 5.95 15.723 15.167V511.35c-28.73-.531-73.165 2.173-116.522 23.308l5.415 14.638 17.342 44.971c25.477-8.123 47.68-14.17 65.035-16.793l28.729-4.336v338.714c0 9.247-6.51 15.147-15.723 15.147H133.157c-9.213 0-15.711-5.9-15.711-15.147V704.836a261.06 261.06 0 0 0 15.17 14.087c9.33 8 23.31 21.136 41.184 36.318 10.302-9.223 19.957-21.246 28.187-29.81 4.776-4.983 9.213-9.759 13.006-14.638-42.815-35.758-86.172-86.171-97.547-100.262V378.035c0-8.67 6.498-15.168 15.711-15.168H242.63l-33.054-100.269H91.432c-40.654 0-74.248 33.06-74.248 74.255v612.924z"/></svg>',
        tooltip: pluginName,
        onAction: function() {
            openDialog();
        }
    });
    editor.ui.registry.addMenuItem('bdmap', {
        text: pluginName,
        onAction: function() {
            openDialog();
        }
    });
    return {
        getMetadata: function() {
            return  {
                name: pluginName,
                url: "http://tinymce.ax-z.cn/more-plugins/bdmap.php",
            };
        }
    };
});
